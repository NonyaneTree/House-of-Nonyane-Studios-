<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>All Employees Payslips</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
.container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
h2, h3 { color: #333; }
.deductions-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
.deductions-table th, .deductions-table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
button { padding: 8px 12px; margin-top: 10px; background: #007BFF; color: white; border: none; cursor: pointer; border-radius: 4px; }
button:hover { background: #0056b3; }
label { display: block; margin-top: 10px; font-weight: bold; }
input[type="text"], input[type="number"], textarea, select, input[type="color"], input[type="date"] { width: 100%; padding: 5px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
.payslip { margin-top: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; }
.payslip h4 { margin: 0; }
.payslip-item { margin-bottom: 5px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
</head>
<body>
<div class="container">
    <h2>Payslip Designer - All Employees</h2>

    <h3>Step 0: Business Information</h3>
    <label>Business Name:</label>
    <input type="text" id="businessName" placeholder="Enter business name">
    <label>Business Address:</label>
    <textarea id="businessAddress" placeholder="Enter business address"></textarea>
    <label>Contact Info:</label>
    <input type="text" id="businessContact" placeholder="Enter contact number or email">
    <label>Theme Color:</label>
    <input type="color" id="themeColor" value="#007BFF">
    <label>Payslip Date:</label>
    <input type="date" id="payslipDate">
    <hr>

    <h3>Step 1: Add Deductions</h3>
    <table class="deductions-table" id="deductionsTable">
        <thead>
            <tr>
                <th>Deduction Name</th>
                <th>Type</th>
                <th>Rate/Amount</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <button onclick="addDeductionRow()">Add Deduction</button>
    <button onclick="downloadAllPayslips()">Download All Payslips</button>
</div>

<script>
function addDeductionRow() {
    const tbody = document.querySelector("#deductionsTable tbody");
    const row = document.createElement("tr");
    row.innerHTML = `
        <td><input type="text" placeholder="e.g. Tax"></td>
        <td>
            <select>
                <option value="percent">%</option>
                <option value="flat">Flat</option>
            </select>
        </td>
        <td><input type="number" placeholder="Value"></td>
        <td><button onclick="this.closest('tr').remove()">Remove</button></td>
    `;
    tbody.appendChild(row);
}

function getDeductions() {
    const rows = document.querySelectorAll("#deductionsTable tbody tr");
    let deductions = [];
    rows.forEach(row => {
        const name = row.querySelector("td:nth-child(1) input").value;
        const type = row.querySelector("td:nth-child(2) select").value;
        const value = parseFloat(row.querySelector("td:nth-child(3) input").value) || 0;
        if (name && value > 0) deductions.push({ name, type, value });
    });
    localStorage.setItem("deductions", JSON.stringify(deductions));
    return deductions;
}

function downloadAllPayslips() {
    let payrollData = JSON.parse(localStorage.getItem("payrollData") || "[]");
    if (payrollData.length === 0) {
        alert("No payroll data found!");
        return;
    }

    const businessName = document.getElementById("businessName").value || "Company Name";
    const businessAddress = document.getElementById("businessAddress").value || "Business Address";
    const businessContact = document.getElementById("businessContact").value || "Contact Info";
    const themeColor = document.getElementById("themeColor").value || "#007BFF";
    const deductions = getDeductions();
    
    const payslipDateInput = document.getElementById("payslipDate").value;
    const payslipDate = payslipDateInput ? new Date(payslipDateInput).toLocaleDateString() : new Date().toLocaleDateString();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    payrollData.forEach((emp, i) => {
        if (i > 0) doc.addPage();

        // Calculate total hours worked
        const totalHoursWorked = emp.dailyRecords.reduce((sum, d) => {
            if (d.attendance === "P") {
                const hoursWorked = Math.max(0, emp.hoursPerDay - (d.lateHours || 0));
                return sum + hoursWorked;
            }
            return sum;
        }, 0);

        // Calculate worked days
        const workedDays = emp.dailyRecords.filter(d => d.attendance === "P").length;

        // âœ… Now use calculated hours for basic pay
        const basicPay = (emp.rate || 0) * totalHoursWorked;

        // Calculate overtime pay
        const overtimePay = emp.dailyRecords.reduce((sum, d) => {
            if (d.attendance === "P") {
                const overtimeRate = emp.rate * (1 + ((d.overtimePercent || 0) / 100));
                return sum + ((d.overtimeHours || 0) * overtimeRate);
            }
            return sum;
        }, 0);

        const grossPay = basicPay + overtimePay;

        let totalDeductions = 0;
        deductions.forEach(d => {
            const amount = d.type === "percent" ? (d.value / 100) * grossPay : d.value;
            totalDeductions += amount;
        });

        const netPay = grossPay - totalDeductions;

        // Format employed date
        let employedDateStr = "N/A";
        if (emp.employedDate) {
            const d = new Date(emp.employedDate);
            if (!isNaN(d.getTime())) {
                employedDateStr = d.toLocaleDateString();
            } else {
                employedDateStr = emp.employedDate;
            }
        }

        // Payslip Header
        doc.setTextColor(themeColor);
        doc.setFontSize(16);
        doc.text(businessName, 10, 10);
        doc.setTextColor(0,0,0);
        doc.setFontSize(10);
        doc.text(businessAddress, 10, 15);
        doc.text(`Contact: ${businessContact}`, 10, 20);

        // Payslip Title
        doc.setTextColor(themeColor);
        doc.setFontSize(14);
        doc.text("Payslip", 10, 35);

        // Employee Details
        doc.setTextColor(0,0,0);
        doc.setFontSize(12);
        doc.text(`Employee: ${emp.name}`, 10, 50);
        doc.text(`Employed Date: ${employedDateStr}`, 10, 60);
        doc.text(`Payslip Date: ${payslipDate}`, 10, 70);
        doc.text(`Rate/hour: ${emp.rate}`, 10, 80);
        doc.text(`Hours/day: ${emp.hoursPerDay}`, 10, 90);
        doc.text(`Days Worked: ${workedDays}`, 10, 100);
        doc.text(`Total Hours Worked: ${totalHoursWorked.toFixed(2)}`, 10, 110);
        doc.text(`Basic Pay: ${basicPay.toFixed(2)}`, 10, 120);
        doc.text(`Overtime Pay: ${overtimePay.toFixed(2)}`, 10, 130);
        doc.text(`Gross Pay: ${grossPay.toFixed(2)}`, 10, 140);

        // Deductions Section
        let y = 160;
        doc.text("Deductions:", 10, y);
        y += 10;
        deductions.forEach(d => {
            const amount = d.type === "percent" ? (d.value / 100) * grossPay : d.value;
            doc.text(`${d.name}: -${amount.toFixed(2)}`, 10, y);
            y += 10;
        });

        // Net Pay and Signatures
        doc.setTextColor(themeColor);
        doc.text(`Net Pay: ${netPay.toFixed(2)}`, 10, y + 10);
        doc.setTextColor(0,0,0);
        doc.text("Signature (HR): ____________________", 10, y + 30);
        doc.text("Signature (Employee): _______________", 10, y + 40);
    });

    doc.save("All_Payslips.pdf");
}
</script>
</body>
</html>
