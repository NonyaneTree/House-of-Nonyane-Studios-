<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Payslip Designer</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
.container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
.deductions-table, .payslip { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
.deductions-table th, .deductions-table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
.employee-card { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 6px; background: #fff; }
button { padding: 8px 12px; margin-top: 10px; background: #007BFF; color: white; border: none; cursor: pointer; }
button:hover { background: #0056b3; }
label { display: block; margin-top: 10px; font-weight: bold; }
input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 5px; margin-top: 5px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
</head>
<body>
<div class="container">
    <h2>Payslip Designer</h2>

    <!-- Business Info -->
    <h3>Step 0: Business Information</h3>
    <label>Business Name:</label>
    <input type="text" id="businessName" placeholder="Enter business name">

    <label>Business Address:</label>
    <textarea id="businessAddress" placeholder="Enter business address"></textarea>

    <label>Contact Info:</label>
    <input type="text" id="businessContact" placeholder="Enter contact number or email">

    <label>Payslip Date:</label>
    <input type="date" id="payslipDate">

    <hr>

    <h3>Step 1: Add Deductions</h3>
    <table class="deductions-table" id="deductionsTable">
        <thead>
            <tr>
                <th>Deduction Name</th>
                <th>Type</th>
                <th>Rate/Amount</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <button onclick="addDeductionRow()">Add Deduction</button>
    <button onclick="generatePayslips()">Generate Payslips</button>

    <h3>Step 2: Preview & Download</h3>
    <div id="payslipList"></div>
    <button id="downloadAllBtn" style="display:none;" onclick="downloadAllPayslips()">Download All Payslips</button>
</div>

<script>
function addDeductionRow() {
    const tbody = document.querySelector("#deductionsTable tbody");
    const row = document.createElement("tr");

    row.innerHTML = `
        <td><input type="text" placeholder="e.g. Tax"></td>
        <td>
            <select>
                <option value="percent">%</option>
                <option value="flat">Flat</option>
            </select>
        </td>
        <td><input type="number" placeholder="Value"></td>
        <td><button onclick="this.closest('tr').remove()">Remove</button></td>
    `;

    tbody.appendChild(row);
}

function getDeductions() {
    const rows = document.querySelectorAll("#deductionsTable tbody tr");
    let deductions = [];
    rows.forEach(row => {
        const name = row.querySelector("td:nth-child(1) input").value;
        const type = row.querySelector("td:nth-child(2) select").value;
        const value = parseFloat(row.querySelector("td:nth-child(3) input").value) || 0;
        if (name && value > 0) {
            deductions.push({ name, type, value });
        }
    });
    return deductions;
}

function generatePayslips() {
    const payrollData = JSON.parse(localStorage.getItem("payrollData") || "[]");
    const deductions = getDeductions();
    const payslipList = document.getElementById("payslipList");
    payslipList.innerHTML = "";

    if (payrollData.length === 0) {
        payslipList.innerHTML = "<p>No payroll data found. Please run payroll first.</p>";
        return;
    }

    payrollData.forEach((emp, index) => {
        let grossPay = emp.totalPay;
        let totalDeductions = 0;
        let deductionsHTML = "";

        deductions.forEach(d => {
            let amount = d.type === "percent" ? (d.value / 100) * grossPay : d.value;
            totalDeductions += amount;
            deductionsHTML += `<p>${d.name}: -${amount.toFixed(2)}</p>`;
        });

        let netPay = grossPay - totalDeductions;

        const card = document.createElement("div");
        card.className = "employee-card";
        card.innerHTML = `
            <h3>${emp.name}</h3>
            <p><strong>Rate/hour:</strong> ${emp.rate}</p>
            <p><strong>Hours/day:</strong> ${emp.hours}</p>
            <p><strong>Days Present:</strong> ${emp.totalPresent}</p>
            <p><strong>Gross Pay:</strong> ${grossPay.toFixed(2)}</p>
            ${deductionsHTML}
            <p><strong>Net Pay:</strong> ${netPay.toFixed(2)}</p>
            <button onclick="downloadPayslip(${index})">Download Payslip</button>
        `;
        payslipList.appendChild(card);
    });

    document.getElementById("downloadAllBtn").style.display = "inline-block";
}

function downloadPayslip(index) {
    const payrollData = JSON.parse(localStorage.getItem("payrollData") || "[]");
    const deductions = getDeductions();
    const emp = payrollData[index];

    // Business info & date
    const businessName = document.getElementById("businessName").value || "Company Name";
    const businessAddress = document.getElementById("businessAddress").value || "Business Address";
    const businessContact = document.getElementById("businessContact").value || "Contact Info";
    const payslipDate = document.getElementById("payslipDate").value || new Date().toLocaleDateString();

    let grossPay = emp.totalPay;
    let totalDeductions = 0;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text(businessName, 10, 10);
    doc.setFontSize(10);
    doc.text(businessAddress, 10, 15);
    doc.text(`Contact: ${businessContact}`, 10, 20);
    doc.text(`Date: ${payslipDate}`, 150, 20);

    doc.setFontSize(14);
    doc.text("Payslip", 10, 35);
    doc.setFontSize(12);
    doc.text(`Employee: ${emp.name}`, 10, 45);
    doc.text(`Rate/hour: ${emp.rate}`, 10, 55);
    doc.text(`Hours/day: ${emp.hours}`, 10, 65);
    doc.text(`Days Present: ${emp.totalPresent}`, 10, 75);
    doc.text(`Gross Pay: ${grossPay.toFixed(2)}`, 10, 85);

    let y = 95;
    deductions.forEach(d => {
        let amount = d.type === "percent" ? (d.value / 100) * grossPay : d.value;
        totalDeductions += amount;
        doc.text(`${d.name}: -${amount.toFixed(2)}`, 10, y);
        y += 10;
    });

    let netPay = grossPay - totalDeductions;
    doc.text(`Net Pay: ${netPay.toFixed(2)}`, 10, y + 10);
    doc.text("Signature (HR): ____________________", 10, y + 20);
    doc.text("Signature (Employee): _______________", 10, y + 30);

    doc.save(`${emp.name}_Payslip.pdf`);
}

function downloadAllPayslips() {
    const payrollData = JSON.parse(localStorage.getItem("payrollData") || "[]");
    payrollData.forEach((_, index) => {
        downloadPayslip(index);
    });
}
</script>
</body>
</html>
